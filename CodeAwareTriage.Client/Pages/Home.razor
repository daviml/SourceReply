@page "/"
@using CodeAwareTriage.Client.Components
@using CodeAwareTriage.Client.Models
@using CodeAwareTriage.Client.Services
@inject ExcelService ExcelService
@inject GeminiService GeminiService
@inject IJSRuntime JS

<header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 bg-[#1a1a24] p-4 rounded-2xl border border-[#2d2d3d] shadow-2xl">
    <h1 class="text-2xl font-bold text-white flex items-center gap-3">
        <span class="w-8 h-8 bg-[#594ae2] rounded-lg flex items-center justify-center text-sm">C</span>
        CodeAware Triage System
    </h1>
    
    <div class="flex flex-wrap gap-3">
        <InputFile OnChange="HandleExcelUpload" class="hidden" id="excelInput" accept=".xlsx" />
        <label for="excelInput" class="cursor-pointer flex items-center gap-2 px-4 py-2 bg-[#21212c] hover:bg-[#2d2d3d] text-white border border-[#3f3f5a] rounded-lg transition-all text-sm font-medium">
            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Importar Chamados (Excel)
        </label>

        <InputFile OnChange="HandleCodeUpload" class="hidden" id="codeInput" multiple />
        <label for="codeInput" class="cursor-pointer flex items-center gap-2 px-4 py-2 bg-[#21212c] hover:bg-[#2d2d3d] text-white border border-[#3f3f5a] rounded-lg transition-all text-sm font-medium">
            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
            Importar Contexto RAG (Código)
        </label>

        <button @onclick="StartAiAnalysis" disabled="@(Rows.Count == 0 || IsProcessing)"
            class="flex items-center gap-2 px-6 py-2 bg-[#594ae2] hover:bg-[#4a3bc1] text-white rounded-lg transition-all text-sm font-bold shadow-lg shadow-purple-900/40 @(IsProcessing ? "opacity-50 cursor-not-allowed animate-pulse" : "")">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
            @(IsProcessing ? "Analisando..." : "Gerar Análise com IA")
        </button>
    </div>
</header>

<DashboardHeader Stats="@Stats" />

<div class="bg-[#1a1a24] rounded-2xl border border-[#2d2d3d] overflow-hidden shadow-2xl flex-grow flex flex-col">
    <div class="overflow-x-auto overflow-y-auto max-h-[600px]">
        <table class="w-full text-left border-collapse min-w-[1000px]">
            <thead class="sticky top-0 z-10 bg-[#21212c]">
                <tr class="border-b border-[#2d2d3d]">
                    <th class="px-4 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider w-12 text-center">
                        <input type="checkbox" class="rounded bg-[#0d0d12] border-[#3f3f5a]" />
                    </th>
                    @foreach (var h in Headers)
                    {
                        <th class="px-4 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider min-w-[120px]">
                            <div class="flex flex-col gap-2">
                                <span>@h</span>
                                <MultiSelectFilter ColumnName="@h" Values="@(Rows.Select(r => r.ContainsKey(h) ? r[h] : ""))" OnFilterChange="@(vals => UpdateFilter(h, vals))" />
                            </div>
                        </th>
                    }
                    <th class="px-4 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider w-64">
                        <div class="flex flex-col gap-2">
                            <span>Veredito IA</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[#2d2d3d]">
                @foreach (var row in FilteredRows)
                {
                    <tr class="hover:bg-[#21212c]/50 transition-colors">
                        <td class="px-4 py-4 text-center">
                            <input type="checkbox" class="rounded bg-[#0d0d12] border-[#3f3f5a] text-[#594ae2]" />
                        </td>
                        @foreach (var h in Headers)
                        {
                            <td class="px-4 py-4 text-sm text-gray-300">
                                @(row.ContainsKey(h) ? row[h]?.ToString() : "")
                            </td>
                        }
                        <td class="px-4 py-4">
                            @if (row.IaVerdict.Status == "idle")
                            {
                                <span class="px-3 py-1 rounded-full bg-[#2d2d3d] text-gray-400 text-xs font-medium">Pendente</span>
                            }
                            else if (row.IaVerdict.Status == "analyzing")
                            {
                                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-purple-500/10 text-purple-400 text-xs font-medium border border-purple-500/30 animate-pulse">
                                    <span class="animate-spin h-3 w-3 border-2 border-purple-500 rounded-full border-t-transparent"></span>
                                    Analisando...
                                </div>
                            }
                            else if (row.IaVerdict.Status == "completed")
                            {
                                <div class="group relative">
                                    <div class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium border
                                        @(row.IaVerdict.Type == "Bug" ? "bg-green-500/10 text-green-400 border-green-500/30" :
                                          row.IaVerdict.Type == "Infra" ? "bg-blue-500/10 text-blue-400 border-blue-500/30" :
                                          "bg-gray-500/10 text-gray-400 border-gray-500/30")">
                                        
                                        <span class="truncate max-w-[150px]">@row.IaVerdict.Type: @row.IaVerdict.Text</span>
                                    </div>
                                    <div class="invisible group-hover:visible absolute z-50 bottom-full left-0 mb-2 w-64 bg-[#0d0d12] border border-[#3f3f5a] p-3 rounded-lg shadow-2xl text-xs text-gray-300 whitespace-normal pointer-events-none">
                                        <p class="font-bold text-white mb-1">Veredito IA (@row.IaVerdict.Type)</p>
                                        @row.IaVerdict.Text
                                    </div>
                                </div>
                            }
                        </td>
                    </tr>
                }
                @if (Rows.Count == 0)
                {
                   <tr>
                       <td colspan="@(Headers.Count + 2)" class="py-20 text-center text-gray-500 italic">
                           Nenhum arquivo carregado. Importe um Excel para começar.
                       </td>
                   </tr>
                }
            </tbody>
        </table>
    </div>
        <div class="px-6 py-3 bg-[#1a1a24] border-t border-[#2d2d3d] flex justify-between items-center text-xs text-gray-500">
          <div>Exibindo @FilteredRows.Count() de @Rows.Count registros</div>
          <div class="flex gap-4">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> IA Ativa</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> RAG Online</span>
          </div>
        </div>
</div>

@if (ShowMappingDialog)
{
    <MappingDialog Headers="@Headers" OnConfirm="HandleMappingConfirm" OnCancel="@(() => ShowMappingDialog = false)" />
}


@code {
    private List<DynamicRow> Rows = new();
    private List<string> Headers = new();
    private ColumnMapping? Mapping;
    private bool ShowMappingDialog;
    private List<CodeFile> CodeContext = new();
    private bool IsProcessing;
    
    // Filtering
    private Dictionary<string, List<object?>> Filters = new();

    private IEnumerable<DynamicRow> FilteredRows => Rows.Where(r => 
        Filters.All(f => f.Value.Count == 0 || f.Value.Contains(r.ContainsKey(f.Key) ? r[f.Key] : null))
    );

    // Stats
    private DashboardStats Stats => CalculateStats();

    private DashboardStats CalculateStats()
    {
        if (Mapping == null) return new DashboardStats { Total = Rows.Count };

        int critical = 0;
        int sla = 0;

        foreach (var r in Rows)
        {
             if (!string.IsNullOrEmpty(Mapping.PriorityColumn) && r.ContainsKey(Mapping.PriorityColumn))
             {
                 var p = r[Mapping.PriorityColumn]?.ToString()?.ToLower() ?? "";
                 if (p.Contains("alta") || p.Contains("crítica") || p.Contains("critical")) critical++;
             }
             if (!string.IsNullOrEmpty(Mapping.DateColumn) && r.ContainsKey(Mapping.DateColumn))
             {
                 if (DateTime.TryParse(r[Mapping.DateColumn]?.ToString(), out var d))
                 {
                     if ((DateTime.Now - d).TotalDays > 3) sla++;
                 }
             }
        }
        return new DashboardStats { Total = Rows.Count, Critical = critical, SlaExceeded = sla };
    }


    private async Task HandleExcelUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            // 5MB limit
            using var stream = file.OpenReadStream(5 * 1024 * 1024); 
            // Need to copy to memory stream because ExcelDataReader might need seek/position which standard browser stream might typically support but explicit memory stream is safer
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            var result = await ExcelService.ParseExcel(ms);
            Headers = result.Headers;
            Rows = result.Rows;
            ShowMappingDialog = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex); 
            // In a real app, show error toast
        }
    }

    private async Task HandleCodeUpload(InputFileChangeEventArgs e)
    {
        var validExtensions = new[] { ".cs", ".js", ".ts", ".sql", ".xml", ".py", ".razor" };
        var files = e.GetMultipleFiles(50); // limit 50 files
        
        List<CodeFile> loadedFiles = new();

        foreach(var f in files)
        {
            if (validExtensions.Any(ext => f.Name.EndsWith(ext)))
            {
                using var stream = f.OpenReadStream(1024 * 1024); // 1MB max per code file
                using var reader = new StreamReader(stream);
                var content = await reader.ReadToEndAsync();
                loadedFiles.Add(new CodeFile { Name = f.Name, Content = content });
            }
        }

        CodeContext.AddRange(loadedFiles);
        // Alert via JS or toast
        await JS.InvokeVoidAsync("alert", $"{loadedFiles.Count} arquivos de código carregados.");
    }

    private void HandleMappingConfirm(ColumnMapping mapping)
    {
        Mapping = mapping;
        ShowMappingDialog = false;
        StateHasChanged();
    }

    private void UpdateFilter(string column, List<object?> values)
    {
        Filters[column] = values;
        StateHasChanged();
    }

    private async Task StartAiAnalysis()
    {
        if (Mapping == null) 
        {
            await JS.InvokeVoidAsync("alert", "Configure o mapeamento primeiro.");
            return;
        }
        if (IsProcessing) return;

        IsProcessing = true;
        StateHasChanged();

        for (int i = 0; i < Rows.Count; i++)
        {
            var row = Rows[i];
            if (row.IaVerdict.Status == "completed") continue;

            row.IaVerdict.Status = "analyzing";
            StateHasChanged(); // Update UI to show spinner

            var description = row.ContainsKey(Mapping.DescriptionColumn) ? row[Mapping.DescriptionColumn]?.ToString() ?? "" : "";
            
            // Simple RAG
            var keywords = description.Split(' ').Where(w => w.Length > 3).Select(w => w.ToLower()).ToList();
            var relevantCode = CodeContext.Where(c => keywords.Any(k => c.Content.ToLower().Contains(k))).Take(3).ToList();

            var result = await GeminiService.AnalyzeTicketAsync(description, relevantCode);
            
            row.IaVerdict.Status = "completed";
            row.IaVerdict.Text = result.Verdict;
            row.IaVerdict.Type = result.Type;
            
            StateHasChanged();
        }

        IsProcessing = false;
    }
}
